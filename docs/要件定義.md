# RemoteWakeConnect 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
RemoteWakeConnect

### 1.2 目的
LAN内でWake On LANを使用してPCを起動し、リモートデスクトップ接続を行うための統合ツール。RDPファイルからの設定読み込みと、マルチモニター構成の柔軟な設定を可能にする。

### 1.3 技術スタック
- フレームワーク: .NET 8.0
- UI: WPF (Windows Presentation Foundation)
- 言語: C# 12.0
- ターゲット: Windows専用 (net8.0-windows)

## 2. 機能要件

### 2.1 Wake On LAN機能
- マジックパケットを送信してPCを起動
- MACアドレスの入力と検証
- IPアドレスの指定（オプション）
- 起動確認機能（pingによる死活監視）
- 非同期処理による応答性の確保

### 2.2 RDPファイル管理機能
- .rdpファイルの読み込み
  - ファイル選択ダイアログ
  - ドラッグ&ドロップ対応
- 接続先情報の自動取得
  - ホスト名/IPアドレス
  - ポート番号
  - ユーザー名
  - ドメイン情報
  - その他の接続設定
- RDPファイルの作成と保存
- rdp_filesフォルダによる統一管理
  - 外部RDPファイルは自動的にrdp_filesフォルダにコピー
  - 直打ち接続時はRDPファイルを自動生成
  - 履歴機能はrdp_filesフォルダのファイルを基準に動作
  - 同一接続先は同じファイル名で使い回し（タイムスタンプなし）
  - ファイル名形式：{ホスト名}.rdp、{IP_アドレス}.rdp、{ホスト名}_port{ポート番号}.rdp

### 2.3 マルチモニター設定機能
- モニター情報の取得
  - mstsc /l コマンドを使用した正確な取得
  - Windows APIによるフォールバック機能
- モニター数の選択（1〜4台、すべて）
- モニター配置のビジュアル表示
- 選択モニターのフラグ管理
- リモート接続時のモニター設定反映

### 2.4 リモートデスクトップ接続機能
- RDP接続の実行（mstsc.exe使用）
- マルチモニター設定の適用
- 接続パラメータの動的生成
- 一時RDPファイルの作成と管理

### 2.5 接続履歴管理
- 接続履歴の保存
- 履歴からの設定読み込み
- 履歴の検絸機能
- 履歴のクリア機能
- ダブルクリックで履歴を使用
- OS情報のYAMLキャッシュ機能（v1.1.0追加）

### 2.6 セッション監視機能（v1.1.0追加）
- Windows Terminal Services APIを使用したセッション情報取得
- リアルタイムセッション状態表示
- 他ユーザー使用中の警告
- 段階的リトライ機能（5秒→10秒→20秒）
- カスタムポート対応

### 2.7 UI要件
- タブ構成
  - 接続設定タブ（メイン画面）
    - RDPファイル設定（上部）
    - Wake On LAN設定（中部）
    - モニター設定（下部）
  - 接続履歴タブ
    - 履歴一覧表示
    - 検索機能
    - 詳細表示
- 直感的な操作
  - ドラッグ&ドロップによるRDPファイル読み込み
  - モニター構成のビジュアル表示（Canvas使用）
  - ツールチップによる入力ガイド

## 3. 非機能要件

### 3.1 パフォーマンス
- 起動時間: 3秒以内
- Wake On LAN送信: 即座に実行
- モニター情報取得: 5秒以内のタイムアウト設定

### 3.2 互換性
- Windows 10/11対応
- .NET 8ランタイム必須
- 単一実行ファイル対応（PublishSingleFile）

### 3.3 セキュリティ
- 資格情報の安全な保存（Windows資格情報マネージャー利用）
- RDPファイルのパスワード情報の適切な処理
- 一時ファイルの適切な削除

### 3.4 エラーハンドリング
- 詳細なデバッグログ出力（debug.log）
- 例外の適切なキャッチと表示
- ユーザーフレンドリーなエラーメッセージ

## 4. アーキテクチャ

### 4.1 プロジェクト構造
```
RemoteWakeConnect/
├── docs/
│   └── 要件定義.md
├── src/
│   ├── App.xaml
│   ├── App.xaml.cs      # デバッグログ機能
│   ├── MainWindow.xaml   # メインUI定義
│   ├── MainWindow.xaml.cs
│   ├── Models/
│   │   ├── MonitorInfo.cs
│   │   └── RdpConnection.cs
│   ├── Services/
│   │   ├── MonitorService.cs      # mstsc /l対応
│   │   ├── RdpFileService.cs
│   │   ├── RemoteDesktopService.cs
│   │   └── WakeOnLanService.cs
│   └── RemoteWakeConnect.csproj
└── publish/              # ビルド出力
```

### 4.2 主要クラス
- **MonitorService**: モニター情報の取得と管理
- **WakeOnLanService**: Wake On LAN機能の実装
- **RdpFileService**: RDPファイルの読み書き
- **RemoteDesktopService**: リモートデスクトップ接続の実行

## 5. 制約事項
- Windows専用アプリケーション
- LAN内での使用を前提
- .NET 8ランタイムのインストールが必要
- 管理者権限は不要

## 6. 既知の問題と対策
- **問題**: アプリケーションアイコン（app.ico）なし
- **対策**: ApplicationIconの参照を削除済み

## 7. 今後の拡張予定
- 接続プロファイルの保存/読み込み機能
- 複数PCの管理機能
- スケジュール起動機能
- ネットワーク診断ツールの統合

## 8. 更新履歴
- 2025-08-13: 初版作成
- 2025-08-13: mstsc /l によるモニター情報取得機能追加
- 2025-08-13: UIレイアウト変更（タブ構成に変更）
- 2025-08-13: デバッグログ機能追加
- 2025-08-15: v1.1.0 セッション監視機能の高速化と最適化
- 2025-08-19: rdp_filesフォルダによる統一RDP管理機能追加
- 2025-08-19: v1.2.1 RDPファイル削除問題修正、履歴選択時の解像度設定改善