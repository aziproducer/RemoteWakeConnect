# リモートセッション監視機能 - 要件定義書

## 1. 概要

### 1.1 機能概要
Remote Wake Connect のRDP接続実行時に、自動的にリモートマシンのセッション状態を確認し、他ユーザーが使用中の場合は警告を表示する機能を追加する。

### 1.2 目的
- **他ユーザーの作業中断を防止** - 意図しない強制切断を回避
- **接続前の自動確認** - ユーザーの手間を省きながら安全性を確保
- **Windows 10/11 Proの制限対応** - 単一セッション制限による問題を事前に警告

### 1.3 基本動作
1. RDP接続ボタンをクリック
2. **自動的にセッション状態を確認**
3. 他ユーザーが使用中なら**警告ダイアログを表示**
4. ユーザーが「接続する」を選択した場合のみ接続実行

## 2. 技術要件

### 2.1 使用API
- **Windows Terminal Services (WTS) API** をP/Invokeで実装
- C#から直接呼び出し可能な形で実装

### 2.2 取得情報
#### セッション情報
- **ユーザー名**: ドメイン\ユーザー名形式
- **セッションID**: セッション識別番号
- **セッションタイプ**: Console / RDP-Tcp#n
- **接続状態**: 
  - WTSActive（アクティブ/操作中）
  - WTSConnected（接続済み/非アクティブ）
  - WTSDisconnected（切断/バックグラウンド）
  - WTSIdle（アイドル状態）
  - WTSListen（リスニング）
  - WTSReset（リセット中）
  - WTSDown（ダウン）
  - WTSInit（初期化中）

#### 拡張情報（オプション）
- ロック状態
- アイドル時間
- ログオン時刻

## 3. 機能設計

### 3.1 UI設計

#### 3.1.1 セッション確認ボタン
**配置場所**: 
- 「接続状態確認」ボタンの隣
- または「Wake & Connect」ボタングループ内

**表示テキスト**: 「セッション確認」

#### 3.1.2 セッション状態表示ダイアログ
**内容**:
```
========================================
[コンピュータ名] のセッション状態
========================================

現在のセッション:
┌─────────────────────────────────────┐
│ ID  │ ユーザー名     │ タイプ    │ 状態        │
├─────────────────────────────────────┤
│ 0   │ -             │ Console   │ Disconnected│
│ 1   │ domain\user1  │ RDP-Tcp#1 │ Active      │
└─────────────────────────────────────┘

⚠ 警告: 他のユーザー (domain\user1) が使用中です。
接続すると既存セッションが切断される可能性があります。

[接続する] [キャンセル]
```

#### 3.1.3 ステータス表示の拡張
- 既存のStatusIndicatorに状態を反映
  - 🟢 緑: 接続可能（セッションなし）
  - 🟡 黄: 自分のセッションあり
  - 🔴 赤: 他ユーザー使用中
  - ⚫ 灰: オフライン/確認不可

### 3.2 処理フロー

#### 3.2.1 RDP接続時の自動確認フロー（メイン機能）
1. 「Connect Only」または「Wake & Connect」ボタンクリック
2. ターゲットマシンへの接続可能性確認（Ping）
3. **セッション状態の自動チェック**
   - WTS APIでセッション情報取得
   - アクティブセッションの確認
4. **判定と処理分岐**
   - 誰も使用していない → そのまま接続
   - 自分のセッションのみ → そのまま接続
   - **他ユーザーが使用中 → 警告ダイアログ表示**
5. ユーザーの選択に応じて接続実行/キャンセル

#### 3.2.2 警告ダイアログの内容
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 他のユーザーが使用中です
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

対象: [コンピュータ名/IPアドレス]

現在使用中のユーザー:
• domain\username1 (RDP-Tcp#1) - Active

接続すると、上記ユーザーのセッションが
切断される可能性があります。

本当に接続しますか？

[はい、接続する] [キャンセル]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 3.2.3 手動セッション確認（補助機能）
- 「セッション確認」ボタンで任意のタイミングで確認可能
- 接続せずに状態だけを確認したい場合に使用

### 3.3 実装クラス設計

#### 3.3.1 SessionMonitorService
```csharp
namespace RemoteWakeConnect.Services
{
    public class SessionMonitorService
    {
        // セッション情報取得
        public async Task<SessionInfo[]> GetSessionsAsync(string hostName);
        
        // 使用状態判定
        public bool IsInUseByOthers(SessionInfo[] sessions, string currentUser);
        
        // セッション詳細取得
        public async Task<SessionDetails> GetSessionDetailsAsync(string hostName, int sessionId);
    }
}
```

#### 3.3.2 データモデル
```csharp
public class SessionInfo
{
    public int SessionId { get; set; }
    public string UserName { get; set; }
    public string DomainName { get; set; }
    public string SessionName { get; set; }
    public WTS_CONNECTSTATE_CLASS State { get; set; }
    public DateTime? LogonTime { get; set; }
    public TimeSpan? IdleTime { get; set; }
    public bool IsLocked { get; set; }
}

public enum WTS_CONNECTSTATE_CLASS
{
    WTSActive,
    WTSConnected,
    WTSConnectQuery,
    WTSShadow,
    WTSDisconnected,
    WTSIdle,
    WTSListen,
    WTSReset,
    WTSDown,
    WTSInit
}
```

#### 3.3.3 P/Invoke定義
```csharp
internal static class WtsApi32
{
    [DllImport("wtsapi32.dll")]
    public static extern IntPtr WTSOpenServerEx(string pServerName);
    
    [DllImport("wtsapi32.dll")]
    public static extern bool WTSEnumerateSessions(
        IntPtr hServer,
        int Reserved,
        int Version,
        out IntPtr ppSessionInfo,
        out int pCount);
    
    // その他必要なAPI定義...
}
```

## 4. 実装手順

### Phase 1: 基本実装
1. WTS API P/Invoke定義の実装
2. SessionMonitorServiceクラスの実装
3. セッション情報取得機能の実装
4. 基本的なセッション状態判定ロジック

### Phase 2: UI統合
1. セッション確認ボタンの追加
2. セッション状態表示ダイアログの実装
3. ステータスインジケーターの拡張
4. 警告メッセージの実装

### Phase 3: 拡張機能
1. 自動セッション確認機能
2. セッション履歴の記録
3. 詳細情報（ロック状態、アイドル時間）の取得
4. 設定による動作カスタマイズ

## 5. エラーハンドリング

### 5.1 想定されるエラー
- ネットワーク接続エラー
- 権限不足エラー
- WTS API未対応（Home Edition等）
- タイムアウト

### 5.2 エラー時の動作
- エラー時は「確認不可」として処理を継続
- 詳細なエラー情報をdebug.logに記録
- ユーザーには簡潔なメッセージを表示

## 6. セキュリティ考慮事項

### 6.1 権限要件
- ターゲットマシンへの適切なアクセス権限が必要
- ドメイン環境では適切な認証が必要

### 6.2 情報の取り扱い
- セッション情報は一時的にメモリ保持のみ
- 個人情報（ユーザー名）のログ出力は最小限に

## 7. テスト要件

### 7.1 単体テスト
- WTS API呼び出しの正常動作確認
- セッション状態判定ロジックのテスト
- エラーハンドリングのテスト

### 7.2 統合テスト
- 実際のWindows環境での動作確認
- 各種セッション状態での確認
- マルチユーザー環境での動作確認

### 7.3 テストケース
1. **オフラインマシン**: エラーハンドリング確認
2. **誰もログオンしていない**: 接続可能表示
3. **自分がログオン中**: 警告なし
4. **他ユーザーがコンソールログオン**: 警告表示
5. **他ユーザーがRDPログオン**: 警告表示
6. **切断セッションのみ**: 状態に応じた表示

## 8. 制限事項

### 8.1 OS制限
- Windows Pro/Enterprise/Server Edition必須
- Home Editionでは一部機能制限あり

### 8.2 ネットワーク制限
- ファイアウォールでRPC通信が許可されている必要あり
- ドメイン環境では適切な信頼関係が必要

### 8.3 同時接続制限
- Windows 10/11 Proは同時1セッションのみ
- Windows Serverは設定により複数セッション可能

## 8.4 Windows Server対応

### 8.4.1 OS種別とRDSの判定
- **Windows 10/11 Pro**: 単一セッション制限あり
  - 新規接続により既存セッションが強制切断される
- **Windows Server（RDS無し）**: 管理用接続のみ
  - 管理用接続（/admin）で2セッションまで
  - 3人目の接続で既存セッションが切断される
  - 実質的にクライアントOSと同様の制限
- **Windows Server（RDS有り）**: 複数セッション許可
  - RDS CALライセンスに応じて同時接続数が決まる
  - ユーザーCALまたはデバイスCALの設定に依存

### 8.4.2 警告表示の差別化

#### Windows 10/11 Pro の場合
```
⚠️ 警告: 他のユーザーが使用中です
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
domain\user1 が現在使用中です。

接続すると、既存のセッションが強制的に
切断されます。

本当に接続しますか？
[はい、接続する] [キャンセル]
```

#### Windows Server（RDS無し）の場合
```
⚠️ 警告: 管理用セッション制限
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
現在のアクティブセッション:
• domain\admin1 (RDP-Tcp#1) - Active
• domain\admin2 (RDP-Tcp#2) - Active

このサーバーはRDSがインストールされていないため、
管理用接続（2セッション）のみ利用可能です。

接続すると、既存のセッションが切断される
可能性があります。

本当に接続しますか？
[はい、接続する] [キャンセル]
```

#### Windows Server（RDS有り）の場合
```
ℹ️ 情報: 複数のユーザーが接続中です
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
現在のアクティブセッション:
• domain\user1 (RDP-Tcp#1) - Active
• domain\user2 (RDP-Tcp#2) - Active
• domain\user3 (RDP-Tcp#3) - Disconnected

このサーバーは複数同時接続をサポートしています。
接続しても既存セッションは維持されます。

[接続する] [キャンセル]
```

### 8.4.3 実装上の考慮点
1. **OS判定ロジック**
   - WMIまたはレジストリでOS種別を判定
   - Win32_OperatingSystemのProductType値で判別
     - 1 = ワークステーション（Pro/Home）
     - 2 = ドメインコントローラー
     - 3 = サーバー

2. **RDSインストール状態の確認**
   - **方法1**: Win32_ServerFeatureでRDS-RD-Serverフィーチャーを確認
   - **方法2**: レジストリキー `HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\TSEnabled` の値確認
   - **方法3**: TermService（Remote Desktop Services）サービスの状態とモード確認
   - **方法4**: WMIでWin32_TerminalServiceSettingのTerminalServerMode値を確認
     - 0 = Remote Administration（管理用のみ）
     - 1 = Application Server（RDS有効）

3. **セッション上限の判定ロジック**
   ```
   if (ProductType == 1) {
       // Windows 10/11 Pro: 1セッション制限
       maxSessions = 1;
       warningLevel = "警告";
   } else if (ProductType >= 2) {
       // Windows Server
       if (RDSInstalled) {
           // RDS有り: ライセンス依存
           maxSessions = GetLicenseCount();
           warningLevel = "情報";
       } else {
           // RDS無し: 管理用2セッション
           maxSessions = 2;
           warningLevel = "警告";
       }
   }
   ```

4. **警告レベルの設定**
   - Windows 10/11 Pro: 警告（⚠️）- 強制切断のリスク
   - Windows Server（RDS無し）: 警告（⚠️）- 管理用制限
   - Windows Server（RDS有り）: 情報（ℹ️）- 通常は影響なし

## 9. 将来の拡張可能性

### 9.1 追加機能案
- セッション強制切断機能
- メッセージ送信機能
- セッション録画/監視機能
- 複数マシン一括確認

### 9.2 他システムとの連携
- Active Directory統合
- イベントログ記録
- SIEM連携

## 10. リリース計画

### Version 1.1.0（メイン機能実装）
- **RDP接続時の自動セッション確認**
- **他ユーザー使用時の警告ダイアログ**
- 基本的なセッション情報取得
- デバッグログ出力

### Version 1.1.1（機能改善）
- 手動セッション確認ボタン追加
- ステータスインジケーター統合
- エラーハンドリング強化

### Version 1.2.0（拡張機能）
- 詳細セッション情報表示
- カスタマイズ可能な警告設定
- セッション履歴記録

## 11. 参考資料

### 11.1 技術文書
- [Windows Terminal Services API Documentation](https://docs.microsoft.com/en-us/windows/win32/api/wtsapi32/)
- [WTS_SESSION_INFO structure](https://docs.microsoft.com/en-us/windows/win32/api/wtsapi32/ns-wtsapi32-wts_session_infow)
- [Remote Desktop Services programming guidelines](https://docs.microsoft.com/en-us/windows/win32/termserv/terminal-services-programming-guidelines)

### 11.2 実装例
- P/Invoke.net のWTS API定義
- pinvoke.net/default.aspx/wtsapi32/WTSEnumerateSessions.html

---

*作成日: 2025-01-14*
*バージョン: 1.0*
*作成者: Claude Code & User*