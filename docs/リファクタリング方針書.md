# RemoteWakeConnect リファクタリング方針書

## 📋 概要
本ドキュメントは、RemoteWakeConnectアプリケーションの包括的なリファクタリング方針を定義します。
現在の機能を維持しながら、段階的に品質とメンテナビリティを向上させることを目的とします。

**作成日**: 2025年1月15日  
**対象バージョン**: v1.1.0  
**GPT-5レビュー済み**: ✅

---

## 🎯 リファクタリング目標

### メトリクス目標
- **MainWindow.xaml.cs**: 1,583行 → 200行未満（ロジックをViewModelへ移行）
- **SessionMonitorService.cs**: 1,052行 → 350行未満
- **循環的複雑度**: 最大12以下、平均5以下
- **ネスト深度**: 最大3レベル
- **テストカバレッジ**: サービス層80%以上、全体60%以上
- **メモリ使用量**: 起動時45MB±10%を維持
- **パフォーマンス**: 既存の処理時間を維持または改善

---

## 📊 優先順位トップ3のリファクタリングタスク

### 1. ネットワーク層の抽象化と非同期化（7-12人日）
**目的**: タイムアウト、リトライ、エラー処理の統一
- 非同期I/Oパターンの統一
- 指数バックオフによる再試行メカニズム
- 接続プールとソケット管理の最適化
- エラー処理の標準化

### 2. データ/状態管理の分離（6-10人日）
**目的**: ドメインロジックとリポジトリの明確な分離
- ドメインモデルとデータモデルの分離
- リポジトリパターンの導入
- 設定管理の一元化
- マイグレーション戦略の実装

### 3. 観測性と品質基盤の整備（5-8人日）
**目的**: デバッグ効率とテスト品質の向上
- 構造化ログ（Microsoft.Extensions.Logging）
- メトリクス収集とトレース
- ユニットテスト＋E2Eテストフレームワーク
- CI/CDパイプライン構築

---

## 🚀 段階的移行計画

### フェーズ0: セーフティネット整備（1-2日）
#### 作業内容
- CI環境構築（.NET 8、Windows環境）
- 静的解析ツール導入（Roslyn Analyzers、StyleCop）
- ログ基盤導入（Microsoft.Extensions.Logging）
- パフォーマンスベースライン測定
- スモークテスト手順の文書化

#### 成果物
- CIパイプライン稼働
- 現状メトリクスの記録
- テスト手順書

### フェーズ1: DI基盤構築（2-3日）
#### 作業内容
- Microsoft.Extensions.Hosting導入
- 既存サービスのインターフェース抽出
- DIコンテナへのサービス登録
- 設定管理（IConfiguration）の導入

#### 成果物
- IWakeOnLanService、ISessionMonitorService等のインターフェース
- HostBuilderによるアプリケーション起動
- appsettings.jsonによる設定管理

### フェーズ2: MVVM移行（5-7日）
#### 作業内容
- CommunityToolkit.Mvvm導入
- MainWindowViewModelの作成
- イベントハンドラ→Commandへの移行
- Behaviorによる非標準イベント処理
- ダイアログサービスの抽象化

#### 成果物
- MainWindow.xaml.csの行数50%削減
- ViewModelによるテスタブルなロジック
- IDialogService、INavigationService

### フェーズ3: SessionMonitorService分割（4-5日）
#### 作業内容
- 責務ごとにサービスを分割
  - ISessionCollector（データ収集）
  - ISessionAnalyzer（状態分析）
  - ISessionNotifier（通知）
  - ISessionRepository（永続化）
- 状態機械パターンの導入
- リトライ/バックオフロジックの共通化

#### 成果物
- 循環的複雑度12以下
- 単一責任の原則に従った小規模サービス群
- テスト可能な純粋関数

### フェーズ4: 品質改善（3-4日）
#### 作業内容
- 例外処理の標準化
- リソース管理（using/Dispose）の徹底
- WeakEvent/WeakReferenceによるメモリリーク対策
- ローカライズ基盤

#### 成果物
- エラーハンドリングガイドライン
- メモリリーク解消
- 多言語対応基盤

### フェーズ5: 最適化と安定化（2-3日）
#### 作業内容
- パフォーマンスプロファイリング
- ボトルネック解消
- 負荷テスト実施
- ドキュメント整備

#### 成果物
- パフォーマンスKPI達成
- 運用ドキュメント
- リリースノート

---

## ⚡ パフォーマンス維持のキーポイント

### 非同期処理
- async/awaitの一貫した使用
- ConfigureAwait(false)の適切な配置
- UIスレッドブロッキングの排除

### メモリ管理
- 大量オブジェクトの遅延初期化
- 適切なキャッシュ戦略
- イベントハンドラの明示的な解除

### ネットワーク最適化
- 接続プールの再利用
- バッチ処理による通信削減
- 適切なタイムアウト設定

### 測定と監視
- 起動時間：1.2秒以内
- 接続処理：2.5秒以内
- メモリ使用量：150MB以下

---

## ⚠️ リスクと緩和策

### 技術的リスク
| リスク | 影響度 | 緩和策 |
|--------|--------|--------|
| 後方互換性破壊 | 高 | 機能フラグ、段階的リリース、ロールバック手順 |
| ネットワーク性能劣化 | 高 | 合成監視、負荷テスト、カナリアリリース |
| メモリリーク | 中 | プロファイリング、WeakReference使用、定期的な測定 |
| 競合状態/デッドロック | 中 | 不変データ構造、メッセージパッシング、静的解析 |
| プラットフォーム依存 | 低 | 抽象化層、契約テスト、動作マトリクス検証 |

### プロジェクトリスク
| リスク | 影響度 | 緩和策 |
|--------|--------|--------|
| スコープクリープ | 高 | 明確な受入基準、段階的な実装 |
| テスト不足 | 中 | 自動テスト必須、カバレッジ目標設定 |
| ドキュメント不足 | 低 | 同時ドキュメント作成、コードコメント |

---

## 📅 全体スケジュール

### マイルストーン
1. **M1: 基盤整備完了**（2週間）
   - CI/CD稼働
   - DI基盤構築
   - 基本的なMVVM移行

2. **M2: コア機能リファクタリング**（3週間）
   - SessionMonitorService分割
   - MainWindow.xaml.cs軽量化
   - テストカバレッジ50%達成

3. **M3: 品質向上**（2週間）
   - エラーハンドリング統一
   - パフォーマンス最適化
   - テストカバレッジ80%達成

4. **M4: リリース準備**（1週間）
   - ドキュメント完成
   - 最終テスト
   - デプロイメント準備

**総工数見積もり**: 30-40人日（バッファ20%含む）

---

## 🔧 推奨技術スタック

### フレームワーク
- **MVVM**: CommunityToolkit.Mvvm
- **DI**: Microsoft.Extensions.DependencyInjection
- **ホスティング**: Microsoft.Extensions.Hosting
- **ログ**: Microsoft.Extensions.Logging + Serilog

### テスト
- **単体テスト**: xUnit + Moq
- **UIテスト**: Appium または WinAppDriver
- **パフォーマンス**: BenchmarkDotNet

### 開発ツール
- **静的解析**: Roslyn Analyzers、StyleCop
- **プロファイリング**: PerfView、dotMemory
- **CI/CD**: GitHub Actions または Azure DevOps

---

## ✅ 実装推奨順序

1. **即座に実施**
   - CI環境構築
   - ログ基盤導入
   - 現状メトリクス測定

2. **短期（1-2週間）**
   - DI基盤構築
   - 基本的なMVVM移行開始
   - 主要サービスのインターフェース化

3. **中期（3-4週間）**
   - MainWindow.xaml.cs分割
   - SessionMonitorService再構築
   - テスト自動化

4. **長期（1-2ヶ月）**
   - 全面的なMVVM移行完了
   - パフォーマンス最適化
   - ドキュメント整備

---

## 📝 成功基準

- [ ] MainWindow.xaml.csが200行以下
- [ ] SessionMonitorServiceの複雑度が12以下
- [ ] テストカバレッジ60%以上
- [ ] 既存機能の完全な動作保証
- [ ] パフォーマンス指標の維持または改善
- [ ] 包括的なドキュメントの完成

---

## 🎯 まとめ

本リファクタリングは、現在の機能を完全に維持しながら、コードの品質、保守性、テスタビリティを大幅に向上させることを目的としています。段階的なアプローチにより、リスクを最小限に抑えながら、着実に改善を進めていきます。

各フェーズでの成果物を明確に定義し、継続的な測定と検証により、プロジェクトの健全性を保ちます。